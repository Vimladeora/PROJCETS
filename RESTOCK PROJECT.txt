import pandas as pd
import numpy as np
from datetime import datetime, timedelta
import sqlite3

# ---------------------------------------------
# CONNECT TO DATABASE
# ---------------------------------------------
conn = sqlite3.connect("inventory_system.db")
cursor = conn.cursor()

# ---------------------------------------------
# LOAD DATA
# ---------------------------------------------
products = pd.read_csv("products.csv")
inventory = pd.read_csv("inventory.csv")
demand = pd.read_csv("demand_history.csv")

inventory['manufacture_date'] = pd.to_datetime(inventory['manufacture_date'])
inventory['expiry_date'] = pd.to_datetime(inventory['expiry_date'])
demand['date'] = pd.to_datetime(demand['date'])

today = datetime.today()

# ---------------------------------------------
# 1. EXPIRY DAYS + STATUS
# ---------------------------------------------
inventory['days_left'] = (inventory['expiry_date'] - today).dt.days

def expiry_status(x):
    if x <= 0:
        return "EXPIRED"
    elif x <= 2:
        return "URGENT"
    elif x <= 5:
        return "EXPIRING SOON"
    return "OK"

inventory['status'] = inventory['days_left'].apply(expiry_status)

# ---------------------------------------------
# 2. DISCOUNT ENGINE
# ---------------------------------------------
def discount_rule(days):
    if days <= 0:
        return 90
    elif days <= 2:
        return 60
    elif days <= 5:
        return 30
    return 0

inventory['discount_%'] = inventory['days_left'].apply(discount_rule)

# ---------------------------------------------
# 3. DEMAND FORECAST (Simple ML logic)
# ---------------------------------------------
forecast = demand.groupby("product_id")['daily_sold'].mean().rename("avg_daily_sales")

inventory = inventory.merge(forecast, on='product_id', how='left')
inventory['avg_daily_sales'] = inventory['avg_daily_sales'].fillna(0)

inventory['predicted_7day_demand'] = inventory['avg_daily_sales'] * 7

# ---------------------------------------------
# 4. RESTOCK ENGINE
# ---------------------------------------------
inventory['restock_flag'] = np.where(
    (inventory['quantity'] < inventory['predicted_7day_demand']) |
    (inventory['status'] == "URGENT"),
    True, False
)

inventory['restock_qty'] = np.where(
    inventory['restock_flag'],
    inventory['predicted_7day_demand'] - inventory['quantity'],
    0
)

inventory['restock_qty'] = inventory['restock_qty'].clip(lower=0)

# ---------------------------------------------
# 5. ALERT SYSTEM
# ---------------------------------------------
alerts = []

for _, row in inventory.iterrows():
    if row['status'] in ("URGENT", "EXPIRED"):
        alerts.append((row['product_id'], 'EXPIRY ALERT',
                       f"Product {row['product_id']} needs urgent action."))

    if row['restock_flag']:
        alerts.append((row['product_id'], 'RESTOCK ALERT',
                       f"Product {row['product_id']} needs restocking: {row['restock_qty']} units."))

alerts_df = pd.DataFrame(alerts, columns=['product_id', 'alert_type', 'message'])

# ---------------------------------------------
# 6. LOAD ALERTS INTO SQL TABLE
# ---------------------------------------------
alerts_df.to_sql("alerts", conn, if_exists='append', index=False)

# ---------------------------------------------
# FINAL OUTPUT
# ---------------------------------------------
print("\nðŸ”µ FINAL INVENTORY SUMMARY:\n")
print(inventory[['product_id','quantity','days_left','status','discount_%','predicted_7day_demand','restock_flag','restock_qty']])


https://chatgpt.com/c/693684b9-6da8-8321-955d-47138038db72
